<!DOCTYPE html>
<style>
  @import url(http://fonts.googleapis.com/earlyaccess/jejugothic.css);
  /* font-family: 'Jeju Gothic', serif; */
  @import url(http://fonts.googleapis.com/earlyaccess/nanumpenscript.css);
  /* font-family: 'Nanum Pen Script', serif; */
  @import url(http://fonts.googleapis.com/earlyaccess/hanna.css);
  /* font-family: 'Hanna', serif; */
  @import url(http://fonts.googleapis.com/earlyaccess/nanumbrushscript.css);
  /* font-family: 'Nanum Brush Script', serif; */
  @import url(http://fonts.googleapis.com/earlyaccess/nanumgothic.css);
  /* font-family: 'Nanum Gothic', serif; */
  @import url(http://fonts.googleapis.com/earlyaccess/jejuhallasan.css);
  /* font-family: 'Jeju Hallasan', serif; */
</style>
<html lang="en">
<head>
  <!-- CDN -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    
    <!-- socket -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <!-- Bootstrap 4 -->
    <script src="static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- AdminLTE App -->
    <script src="static/dist/js/adminlte.min.js"></script>

  <!-- meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- title -->
    <title>FINAL PROJECT</title>

  <!-- style -->
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="static/plugins/fontawesome-free/css/all.min.css">
  
    <!-- icheck bootstrap -->
    <link rel="stylesheet" href="static/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  
    <!-- Theme style -->
    <link rel="stylesheet" href="static/dist/css/adminlte.min.css">
    <script>
      function test(){
              var ban = $('#ban').val();
              $.ajax({
                      type : 'POST',                                  //<!--GET / POST-->
                      url : `{{url_for('ban')}}`,
                      data : {
                              ban_id:ban                       //<!--key : "value"-->
                      },
                      dataType : 'text',
                      success : function(result){
                        if (result=='no'){
                          alert('중복입니다')
                          $('#ban').val('')
                        }
                        else{
                              var font = "font-family:'Jeju Gothic'";
                              var keyword =  `<li style="font-family:'Jeju Gothic'">${result}</li>`;
                              $('#keyword:last-child()').append(keyword);
                              alert('추가되었습니다')
                              $('#ban').val('')
                            }
                      },
                      error : function(xtr,status,error){
                              alert(xtr +":"+status+":"+error);
                      }
              });
      }

      </script>
<script>
  user="{{ip_addr}}"
</script>
</head>

<body>



  <!-- container - 채팅 -->
  <div class='container-fluid col-md-12'>

    <!-- container header -->
    <div class='content_header d-flex justify-content-center'>
      <div class="login-logo">
        <!-- 버전 정의 -->
        <!-- 모델변경.해당모델결과변경.웹변경으로 하겠습니다 ㅎㅎ  -->
        <!--  ~ 21.05.18 웹 환경 변경으로 1.0.10으로 마감  -->  
        <!--  21.05.19 폰트별 가중치 부여로 1.1 버전 시작  -->
        <!-- 21.05.21 1.1.1서비스 시연 방법 설명 추가 -->
        <!--  한자를 지원하는 폰트가 아니어서 추가적으로 최적 폰트 조사가 필요 -->  
        <b style="color: brown; font-family: HANNA;">키워드 필터링 ver 1.1.1</b></a>
      </div>    
    </div>

    <!-- card -->
    <div class="card direct-chat d-flex justify-content-center col-md-9 mx-auto">
      
      <!-- card header -->
      <div class="card-header ">
        <h3 class="card-title">Chat</h3>
        
        <!-- stop keyword button -->
        <div class="card-tools">
          <button type="button" class="btn btn-tool" title="Contacts" data-widget="chat-pane-toggle" onclick="$('#scroll_area').animate({scrollTop : 0}, 10)">
            <h5 class="card-title" style="font-family: Jeju Gothic;">금지어 확인 및 추가하기</h5>
            <!-- <i class="fas fa-ban"></i> -->
          </button>
        </div>  
      </div>

      <!-- card body -->
      <div class="card-body" id="scroll_area" style="height: 500px;scroll-behavior:smooth">
        
        <!-- message box -->
        <div class="direct-chat-messages" id='chatbox' style="height: auto;">
        </div>

        <!-- contacts -->
        <div class="direct-chat-contacts">
          <ul class="contacts-list">
            <li>
              <a href="#">
                <div class="contacts-list">
                <span class="contacts-list-name" style='color:white;'>
                  <h3 style="font-family: Nanum Pen Script;"> 금지어 </h3>
                  <ul id='keyword'>
                    {% for keyword in keywords %}
                      <li style="font-family: 'Jeju Gothic'">{{keyword}}</li>
                    {% endfor %}
                  </ul>
                </span>
                <span
                      ><button
                        style="float: right; background: none; border: 0"
                        id="enter_btn"
                      >
                        <p style="color:white; font-family: 'Jeju Gothic '">금지하고자 하는 단어를 입력하세요.</p>
                        <input style=" font-family: 'Jeju Gothic'" type = "text" name="ban"  id="ban" onkeydown="if (event.keyCode==13){test()};"/>
                        <input id ='append' type = "button" value = "추가" onclick = 'test();' /></button
                    ></span>
                </div>
              </a>
            </li>

          </ul>
        </div>
      </div>

      <!-- card footer -->
      <div class="card-footer">
        <form action="#" method="post" onsubmit="return false;">
          <div class="input-group">
            <input type="text" type='hidden' name="message" placeholder="메시지를 입력하세요 ..." class="form-control">
            <input type='hidden'/>
            <span class="input-group-append">
              <button id='send_btn' type="button" class="btn btn-primary">Send</button>
            </span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- container - 채팅사용설명서 -->
  <div class='container-fluid col-md-12'>
    <div class='content_header d-flex justify-content-center'>
      <div class="login-logo">
        <p style="color: black; font-family: HANNA;">채팅 사용 설명서</p>
        <li style="font-size: 15px; font-family: Jeju Gothic;">채팅창에 '사과티비'를 변형해서 입력해보세요! ex)ㅅr고rEl비</li>
        <li style="font-size: 15px; font-family: Jeju Gothic;">우측 상단의 "금지어 확인 및 추가하기"를 통해 금지어 목록을 보고, 
          원하는 금지어를 추가할 수 있어요! </li>
      </div>
    </div>
  </div>

  
  <!-- 채팅 기능 구현 -->
  <script>
  // 1. 변수 초기화
    var trigger = false;
    var socket = "";
    var msg = "";
    var msg_trigger = "0";
 
  // 2. 소켓 연결
    // 2-1. url 설정
      url = "http://" + document.domain + ":" + location.port;
  
    // 2-2. 소켓 연결
      socket = io.connect(url);
    
  // 3. 메시지 발신 처리
    // 3-1. 키보드 입력 이벤트 처리
      $("[name=message]").on("keypress", (evt) => {
        console.log(user)
        if (evt.keyCode == 13) {
          var msg = encodeURI($("[name=message]").val().trim());
          socket.emit("c_send_msg", { username: user, msg: msg });
          $("[name=message]").val("");
        }
      });

    // 3-2. 전송 버튼 클릭 이벤트 처리
      $("#send_btn").on("click", () => {
        console.log(user)
        var msg = encodeURI($("[name=message]").val().trim());
        socket.emit("c_send_msg", { username: user, msg: msg });
        $("[name=message]").val("");
      });

  // 4. 메시지 수신 처리    
    socket.on("s_send_msg", (data) => {
      var sender = decodeURI(data.user);
      var msg = decodeURI(data.msg);

      // 4-1. 타인이 보낸 메시지를 화면에 출력하는 경우 
        if (sender != decodeURI(user)) {
          var msghtml = `
            <div class="direct-chat-msg">
              <div class="direct-chat-infos clearfix">
                <span class="direct-chat-name float-left">${sender}</span>
              </div>
              <img class="direct-chat-img" src="static/dist/img/unknown.png" alt="message user image">
              <div class="direct-chat-text">
                ${msg}
              </div>
            </div>`

      // 4-2. 내가 보낸 메시지를 화면에 출력하는 경우
        } else {
          var msghtml = `
            <div class="direct-chat-msg right">
              <div class="direct-chat-infos clearfix">
                <span class="direct-chat-name float-right">${sender}</span>
              </div>
              <img class="direct-chat-img" src="static/dist/img/unknown.png" alt="message user image">
              <div class="direct-chat-text">
                ${msg}
              </div>
            </div>`
        }
      // 4-3. 화면에 메시지 추가
        $("#chatbox").append(msghtml);
      
      // 4-4. 스크롤 다운
        $("#scroll_area").scrollTop($("#scroll_area")[0].scrollHeight);

      })

    socket.on("init_msg", (data) => {
      var sender = decodeURI(data.user);
      var msg = decodeURI(data.msg);
      var msghtml = `
        <div class="direct-chat-msg">
          <div class="direct-chat-infos clearfix">
            <span class="direct-chat-name float-left">${sender}</span>
          </div>
          <img class="direct-chat-img" src="static/dist/img/세종.jpg" alt="message user image">
          <div class="direct-chat-text">
            ${msg}
          </div>
        </div>`
        $("#chatbox").append(msghtml);
        $("#scroll_area").scrollTop($("#scroll_area")[0].scrollHeight);
      })

  </script>
</body>

</html>
